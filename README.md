# ç¾½æ¯›çƒå›åˆæ£€æµ‹å™¨ - æ¨¡å—åŒ–ç‰ˆæœ¬

åŸºäºQwen-VLç³»åˆ—æ¨¡å‹çš„ç¾½æ¯›çƒè§†é¢‘å›åˆæ£€æµ‹å·¥å…·ï¼Œæ”¯æŒå‘çƒæ£€æµ‹å’Œæ™ºèƒ½å›åˆåˆ†å‰²ï¼Œç°å·²é›†æˆvLLMé«˜æ€§èƒ½æ¨ç†åç«¯ã€‚

## âœ¨ åŠŸèƒ½ç‰¹ç‚¹

- ğŸš€ **vLLMåŠ é€Ÿ**: æ”¯æŒvLLMåç«¯ï¼Œæ¨ç†é€Ÿåº¦æå‡2-5å€
- ğŸ§  **æ™ºèƒ½æ£€æµ‹**: å…ˆæ£€æµ‹å‘çƒåŠ¨ä½œï¼Œå†åŸºäºå‘çƒåˆ†å‰²å›åˆ
- ğŸ“Š **æ¨¡å—åŒ–æ¶æ„**: æ¸…æ™°çš„ä»£ç ç»“æ„ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
- ğŸ”„ **æ··åˆåç«¯**: æ™ºèƒ½é€‰æ‹©æœ€ä¼˜æ¨ç†åç«¯ï¼Œæ”¯æŒè‡ªåŠ¨å›é€€
- ğŸ¯ **åŒé‡æ¨¡å¼**: æ”¯æŒå‘çƒé©±åŠ¨å’Œä¼ ç»Ÿæ—¶é—´ç‰‡æ®µä¸¤ç§æ£€æµ‹æ–¹å¼
- ğŸ“ˆ **å¹¶è¡Œå¤„ç†**: å¤šçº¿ç¨‹å¹¶è¡Œåˆ†æï¼Œæå‡å¤„ç†æ•ˆç‡
- ğŸ“„ **å¤šæ ¼å¼è¾“å‡º**: JSONã€CSVã€TXTæ ¼å¼ç»“æœå¯¼å‡º
- ğŸ”§ **çµæ´»é…ç½®**: æ”¯æŒå¤šç§æ¨¡å‹å’Œè‡ªå®šä¹‰å‚æ•°

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒæ¨¡å—
```
src/
â”œâ”€â”€ universal_rally_detector.py    # ä¸»å…¥å£ï¼Œé›†æˆæ‰€æœ‰åŠŸèƒ½
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ base_detector.py          # åŸºç¡€æ¨¡å‹åŠ è½½å™¨
â”‚   â”œâ”€â”€ video_processor.py        # ä¼ ç»ŸTransformersåç«¯
â”‚   â”œâ”€â”€ hybrid_video_processor.py # æ··åˆåç«¯å¤„ç†å™¨  
â”‚   â”œâ”€â”€ vllm_detector.py          # vLLMé«˜æ€§èƒ½åç«¯
â”‚   â”œâ”€â”€ serve_detector.py         # å‘çƒåŠ¨ä½œæ£€æµ‹å™¨
â”‚   â””â”€â”€ rally_analyzer.py         # å›åˆåˆ†æå™¨
â””â”€â”€ utils/
    â”œâ”€â”€ response_parser.py         # å“åº”è§£æå™¨
    â””â”€â”€ exporter.py               # ç»“æœå¯¼å‡ºå™¨
```

### æ”¯æŒçš„æ¨¡å‹
- **Qwen2.5-VL-3B-Instruct** âœ… (æ¨èï¼Œå¿«é€Ÿ)
- **Qwen2.5-VL-7B-Instruct** âœ… (é«˜ç²¾åº¦)  
- **Qwen3-VL-2B-Instruct** âœ… (æœ€æ–°ï¼Œéœ€vllm>=0.11.0)
- **Qwen3-VL-8B-Instruct** âœ… (æœ€é«˜ç²¾åº¦)

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–
```bash
# åŸºç¡€ä¾èµ–
pip install -r requirements.txt

# å¯é€‰ï¼švLLMé«˜æ€§èƒ½åç«¯
pip install vllm>=0.11.0 ray
```

### 2. åŸºæœ¬ä½¿ç”¨
```bash
# å‘çƒé©±åŠ¨çš„å›åˆæ£€æµ‹ï¼ˆæ¨èï¼‰
python src/universal_rally_detector.py --video video.mp4 --method serve_based

# ä¼ ç»Ÿæ—¶é—´ç‰‡æ®µæ£€æµ‹
python src/universal_rally_detector.py --video video.mp4 --method time_based

# ä½¿ç”¨vLLMé«˜æ€§èƒ½åç«¯
python src/universal_rally_detector.py --video video.mp4 --backend vllm
```

### å‚æ•°è¯´æ˜

| å‚æ•° | å¿…éœ€ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--video` | âœ… | - | è§†é¢‘æ–‡ä»¶è·¯å¾„ |
| `--model` | âŒ | Qwen/Qwen2.5-VL-3B-Instruct | ä½¿ç”¨çš„æ¨¡å‹åç§° |
| `--segment-duration` | âŒ | 3.0 | åˆ†æç‰‡æ®µæ—¶é•¿ï¼ˆç§’ï¼‰ |
| `--overlap` | âŒ | 1.0 | ç‰‡æ®µé‡å æ—¶é•¿ï¼ˆç§’ï¼‰ |
| `--output` | âŒ | - | è¾“å‡ºæ–‡ä»¶è·¯å¾„ |
| `--output-format` | âŒ | json | è¾“å‡ºæ ¼å¼ï¼ˆjson/csv/txtï¼‰ |
| `--max-segments` | âŒ | - | æœ€å¤§å¤„ç†ç‰‡æ®µæ•°ï¼ˆæµ‹è¯•ç”¨ï¼‰ |
| `--verbose` | âŒ | - | è¯¦ç»†è¾“å‡ºæ¨¡å¼ |

## è¾“å‡ºæ ¼å¼

### JSONæ ¼å¼
```json
{
  "video_path": "badminton_video.mp4",
  "video_duration": 120.5,
  "rally_count": 3,
  "rallies": [
    {
      "rally_id": 1,
      "start_time": 10.2,
      "end_time": 25.8,
      "duration": 15.6,
      "dominant_action": "å¯¹æ‹‰",
      "avg_intensity": "é«˜",
      "segment_count": 3
    }
  ]
}
```

### CSVæ ¼å¼
```csv
Rally_ID,Start_Time,End_Time,Duration,Action_Type,Intensity,Segments
1,10.20,25.80,15.60,å¯¹æ‹‰,é«˜,3
2,45.30,52.10,6.80,å‘çƒ,ä¸­,2
```

### TXTæ ¼å¼
```
ç¾½æ¯›çƒå›åˆæ—¶é—´ç‚¹ - badminton_video.mp4
============================================================
è§†é¢‘æ—¶é•¿: 120.5ç§’
æ€»å…±æ£€æµ‹åˆ° 3 ä¸ªå›åˆ

å›åˆ 1:
  æ—¶é—´: 10.2s - 25.8s
  æ—¶é•¿: 15.6ç§’
  ä¸»è¦åŠ¨ä½œ: å¯¹æ‹‰
  æ¿€çƒˆç¨‹åº¦: é«˜
  ç‰‡æ®µæ•°é‡: 3
```

## å·¥ä½œåŸç†

### 1. è§†é¢‘åˆ†ç‰‡
- å°†è§†é¢‘æŒ‰æŒ‡å®šæ—¶é•¿åˆ‡åˆ†æˆé‡å çš„ç‰‡æ®µ
- æ¯ä¸ªç‰‡æ®µæå–å›ºå®šæ•°é‡çš„å…³é”®å¸§ï¼ˆé»˜è®¤6å¸§ï¼‰
- æ”¯æŒè‡ªå®šä¹‰ç‰‡æ®µæ—¶é•¿å’Œé‡å è®¾ç½®

### 2. æ™ºèƒ½åˆ†æ
- ä½¿ç”¨Qwen2.5-VLæ¨¡å‹åˆ†ææ¯ä¸ªç‰‡æ®µ
- è¯†åˆ«æ˜¯å¦åŒ…å«ç¾½æ¯›çƒå›åˆæ´»åŠ¨
- åˆ†æåŠ¨ä½œç±»å‹ï¼ˆå‘çƒã€å¯¹æ‹‰ã€æ€çƒç­‰ï¼‰
- è¯„ä¼°å›åˆæ¿€çƒˆç¨‹åº¦

### 3. ç»“æœåˆå¹¶
- è‡ªåŠ¨åˆå¹¶ç›¸é‚»çš„å›åˆç‰‡æ®µ
- é¿å…åŒä¸€å›åˆè¢«é‡å¤è®¡ç®—
- ç”Ÿæˆè¿ç»­çš„æ—¶é—´æ®µä¿¡æ¯

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. GPUåŠ é€Ÿ
- ç¡®ä¿å®‰è£…äº†CUDAç‰ˆæœ¬çš„PyTorch
- æ¨¡å‹ä¼šè‡ªåŠ¨ä½¿ç”¨å¯ç”¨çš„GPUèµ„æº

### 2. å†…å­˜ä¼˜åŒ–
- å¯¹äºé•¿è§†é¢‘ï¼Œå»ºè®®åˆ†æ®µå¤„ç†
- ä½¿ç”¨`--max-segments`å‚æ•°é™åˆ¶å¤„ç†é•¿åº¦

### 3. å‚æ•°è°ƒä¼˜
- **segment-duration**: è¾ƒçŸ­çš„ç‰‡æ®µ(2-3ç§’)æé«˜ç²¾åº¦ï¼Œè¾ƒé•¿çš„ç‰‡æ®µ(5-8ç§’)æé«˜æ•ˆç‡
- **overlap**: é€‚å½“é‡å (1-2ç§’)ç¡®ä¿ä¸é—æ¼å›åˆè¾¹ç•Œ

## ç¤ºä¾‹ç”¨æ³•

### 1. å¿«é€Ÿæµ‹è¯•
```bash
# åªåˆ†æå‰10ä¸ªç‰‡æ®µ
python rally_detector_standalone.py \
    --video test.mp4 \
    --max-segments 10 \
    --verbose
```

### 2. ç²¾ç¡®åˆ†æ
```bash
# ä½¿ç”¨è¾ƒçŸ­ç‰‡æ®µå’Œé€‚å½“é‡å 
python rally_detector_standalone.py \
    --video match.mp4 \
    --segment-duration 2.0 \
    --overlap 0.5 \
    --output detailed_results.json
```

### 3. æ‰¹é‡å¯¼å‡º
```bash
# å¯¼å‡ºä¸ºCSVæ ¼å¼ä¾¿äºExcelå¤„ç†
python rally_detector_standalone.py \
    --video tournament.mp4 \
    --output-format csv \
    --output rally_timestamps.csv
```

## æŠ€æœ¯ç»†èŠ‚

### æ¨¡å‹ä¿¡æ¯
- **é»˜è®¤æ¨¡å‹**: Qwen/Qwen2.5-VL-3B-Instruct (æ¨è)
- **æ”¯æŒçš„æ¨¡å‹**:
  - `Qwen/Qwen2.5-VL-3B-Instruct` âœ… (æ¨èï¼Œå®Œå…¨æµ‹è¯•é€šè¿‡)
  - `Qwen/Qwen2.5-VL-7B-Instruct` âœ… (æ›´é«˜ç²¾åº¦ï¼Œæœªæµ‹è¯•)
  - `Qwen/Qwen3-VL-2B-Instruct` âš ï¸ (å…¼å®¹æ€§é—®é¢˜ï¼Œæ¨ç†å¯èƒ½å¤±è´¥)
  - `Qwen/Qwen3-VL-8B-Instruct` âš ï¸ (å…¼å®¹æ€§é—®é¢˜ï¼Œæ¨ç†å¯èƒ½å¤±è´¥)
- **è¾“å…¥**: è§†é¢‘å¸§åºåˆ— + æ–‡æœ¬æç¤º
- **è¾“å‡º**: ç»“æ„åŒ–çš„å›åˆæ£€æµ‹ç»“æœ

### æ£€æµ‹é€»è¾‘
- **å›åˆè¯†åˆ«**: åŸºäºå…³é”®è¯å’Œè¯­ä¹‰åˆ†æ
- **åŠ¨ä½œåˆ†ç±»**: å‘çƒã€æ¥å‘çƒã€å¯¹æ‹‰ã€æ€çƒã€åŠçƒã€ç½‘å‰çƒ
- **å¼ºåº¦è¯„ä¼°**: ä½ã€ä¸­ã€é«˜ä¸‰ä¸ªçº§åˆ«

### æ–‡ä»¶ç»“æ„
```
qwen-vl/
â”œâ”€â”€ venv/                      # Pythonè™šæ‹Ÿç¯å¢ƒ
â”œâ”€â”€ rally_detector_standalone.py  # ä¸»ç¨‹åº
â”œâ”€â”€ 424_raw.MOV               # æµ‹è¯•è§†é¢‘
â”œâ”€â”€ test_results.json         # è¾“å‡ºç»“æœ
â””â”€â”€ README.md                 # ä½¿ç”¨è¯´æ˜
```

## å¸¸è§é—®é¢˜

### Q: æ¨¡å‹ä¸‹è½½æ…¢æ€ä¹ˆåŠï¼Ÿ
A: é¦–æ¬¡è¿è¡Œæ—¶ä¼šè‡ªåŠ¨ä¸‹è½½Qwen2.5-VLæ¨¡å‹(çº¦6GB)ï¼Œå»ºè®®ä½¿ç”¨ç¨³å®šçš„ç½‘ç»œè¿æ¥ã€‚

### Q: å†…å­˜ä¸è¶³æ€ä¹ˆå¤„ç†ï¼Ÿ
A: å¯ä»¥å‡å°‘`max_frames`å‚æ•°æˆ–ä½¿ç”¨æ›´çŸ­çš„`segment_duration`ã€‚

### Q: æ£€æµ‹å‡†ç¡®ç‡å¦‚ä½•æé«˜ï¼Ÿ
A: è°ƒæ•´ç‰‡æ®µè®¾ç½®ï¼Œç¡®ä¿æ¯ä¸ªç‰‡æ®µåŒ…å«å®Œæ•´çš„åŠ¨ä½œåºåˆ—ã€‚

### Q: æ”¯æŒå“ªäº›è§†é¢‘æ ¼å¼ï¼Ÿ
A: æ”¯æŒOpenCVå¯è¯»å–çš„æ‰€æœ‰æ ¼å¼ï¼ŒåŒ…æ‹¬MP4ã€AVIã€MOVç­‰ã€‚

### Q: Qwen3-VLæ¨¡å‹ä¸ºä»€ä¹ˆæ¨ç†å¤±è´¥ï¼Ÿ
A: Qwen3-VLæ¨¡å‹ä¸å½“å‰transformersåº“ç‰ˆæœ¬å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ï¼Œå»ºè®®ä½¿ç”¨Qwen2.5-VLæ¨¡å‹ã€‚

### Q: å¦‚ä½•ä½¿ç”¨ä¸åŒçš„æ¨¡å‹ï¼Ÿ
A: ä½¿ç”¨`--model`å‚æ•°æŒ‡å®šæ¨¡å‹åç§°ï¼Œä¾‹å¦‚ï¼š
```bash
python rally_detector_standalone.py --video video.mp4 --model "Qwen/Qwen2.5-VL-7B-Instruct"
```

## æ›´æ–°æ—¥å¿—

### v1.0.0 (2024-11-06)
- åŸºäºQwen2.5-VLçš„åˆå§‹ç‰ˆæœ¬
- æ”¯æŒå›åˆæ£€æµ‹å’Œæ—¶é—´ç‚¹è¾“å‡º
- å¤šæ ¼å¼ç»“æœå¯¼å‡º
- å®Œå…¨ç‹¬ç«‹è¿è¡Œï¼Œæ— å¤–éƒ¨ä¾èµ–

## è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäºMITè®¸å¯è¯å¼€æºã€‚